## 实时视频流会话仿真平台

### 一、介绍

针对基于强化学习的码率智能自适应算法 DRL-ABR，在理想情况下，应该使用真实的实时视频流平台进行训练。然而，在标准视频流环境下模拟实时视频会话状态，需要通过网络浏览器不断下载视频分块文件。这种方法导致训练时间过长，网络模型无法有效收敛，因为强化学习训练算法必须等到实时视频流会话中所有视频分块文件全部下载完后再去更新模型。为了解决该问题，设计并实现一个实时视频流会话仿真平台去训练 ABR 算法是很有必要的，该仿真平台可以真实地模拟客户端应用程序的完整视频流会话周期，便于加速网络模型的训练过程。

在实时视频流会话仿真平台中，对于每个视频分块下载，仿真平台会基于该视频分块的码率和输入网络 trace 的吞吐率数据，来计算它的下载时间。然后仿真平台将当前视频分块的下载时间来消耗缓冲区，去表示下载过程中的视频播放情况，同时将已下载视频分块的时间段大小补充到缓冲区内。另外，当发生视频分块下载时间超过下载前的缓冲区占用时间段的事件后，仿真平台会模拟视频卡顿场景。

### 二、整体框架

如图所示，描述了实时视频流会话仿真平台系统架构图，它是一个使用 Python 语言设计开发的类似于真实播放器应用程序的系统仿真平台。使用该仿真平台，不需要研究人员对于真实播放器内部框架组成和复杂的逻辑实现细节进行详细了解，从而有利于算法研究设计的快速开发和实验性能评估分析。该仿真平台将视频源文件列表、 网络 trace 文件和所设计的优化算法对象（自适应码率决策算法和实时视频超分算法） 作为输入参数，利用仿真平台的调度控制逻辑，来真实模拟实时视频流会话进程及算法执行策略。最终，将根据预先定义好的 QoE 统一量化评估指标集合输出作为整体算法的性能评估标准。该实时视频流会话仿真平台完整模拟了真实实时视频流应用平台的控制逻辑和调度策略，方便了算法设计开发工作以及网络模型的快速训练收敛过程。

<img src="https://s2.loli.net/2022/05/30/d2XC1IlLnuogJmK.png" alt="figure_4_2_2.png" style="zoom: 67%;" />

### 三、代码结构

1. player.py：实时视频流仿真播放器，可以模拟视频的请求下载和卡顿现象。
2. server.py：流媒体仿真服务器，可以模拟视频的转发请求和控制选择功能。
3. emulator.py：一个实时视频流仿真平台，将服务器和客户端播放器结合在一起。
4. util.py：一个用于计算网络带宽信息的工具函数库，包括带宽信息加载、trace信息获取等常用函数。
5. algorithms：一个ABR算法文件夹，包括对比算法与所设计的实时视频流优化算法Streamlet。


### 三、代码解释

2. server.py：流媒体仿真服务器，可以模拟视频的转发请求和控制选择功能。
这是一个直播流服务器的 Python 代码，用于生成直播流的视频和音频数据。代码中的 Live_Server 类包含多个方法和属性，用于生成视频数据的各个组成部分。以下是代码的主要部分：

__init__ 方法：初始化方法，用于设置初始值并生成当前分段（chunk）的大小等信息。
generate_chunk_size 方法：用于生成当前分段（chunk）的大小信息，根据不同的码率、分段数等信息进行生成。
encoding_update 方法：用于更新编码过程，根据开始和结束时间生成对应的分段（chunk）并插入编码缓冲区。
update 方法：用于更新数据，根据下载的数据生成下一次的数据请求。
除此之外，代码还导入了一些模块和类，例如 numpy、Config、Env_Config 和 Random 等。其中，Config 类和 Env_Config 类用于设置一些参数和配置信息，Random 类用于生成随机数。

当运行这段代码时，会执行以下步骤：

导入需要使用的模块，如numpy模块、Config模块和Env_Config模块等。

定义了一个Live_Server类，包含了一些成员变量和成员函数。__init__函数是Live_Server类的构造函数，用于初始化类的成员变量，包括一个随机数生成器、初始延迟、码率、分片时长等等。generate_chunk_size函数用于生成分片的大小，encoding_update函数用于对编码进行更新，update函数用于对服务器状态进行更新。

如果这段代码是直接运行的，那么会执行一些初始化的操作。如果这段代码是被其他模块调用的，那么这些初始化的操作就不会被执行。

无论是直接运行还是被调用，Live_Server类都会被实例化，然后通过调用该类的各个成员函数，完成对服务器状态的更新。

总体来说，这段代码是用Python编写的一个直播视频流媒体服务器程序。该程序通过Live_Server类来管理视频编码、分片和传输等过程，支持多个不同的视频码率，能够自适应调整视频质量，从而在不同的网络环境下实现最优的视频播放效果。


### 四、执行命令

运行testing.py文件，指定参数设置，包括是否有启动延迟、随机延迟使用，然后开始进行实时视频流仿真会话进程，结束后将结果信息存放在result文件夹下。